<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Enter VIN ‚Äî TrustCar.io</title>
    <meta name="description" content="Decode vehicle VIN numbers with TrustCar.io. Get instant safety ratings, recall information, and vehicle specifications from NHTSA data.">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f8fa; color: #0b1724; }
        header { background: linear-gradient(135deg, #0553F0 0%, #0441c7 100%); color: white; padding: 1.5rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(5,83,240,0.15);; gap: 1rem; }
        .logo { font-size: 1.8rem; font-weight: 800; }
        .menu-toggle { display: none; align-items: center; gap: .4rem; background: rgba(255,255,255,0.12); color: white; border: 2px solid rgba(255,255,255,0.25); border-radius: 10px; padding: .55rem .9rem; font-weight: 700; cursor: pointer; }
        .menu-toggle:focus-visible { outline: 2px solid #fff; outline-offset: 2px; }
        a.nav-link { color: white; text-decoration: none; margin-left: 1.5rem; font-weight: 600; transition: opacity .2s; }
        a.nav-link:hover { opacity: 0.85; }
        main { padding: 3rem 5%; display: flex; justify-content: center; }
        .card { width: 100%; max-width: 920px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; padding: 2.5rem; box-shadow: 0 8px 24px rgba(2,6,23,0.08); border: 2px solid #e6eefc; }
        h1 { margin: 0 0 0.75rem 0; font-size: 2.2rem; font-weight: 800; color: #0b1724; }
        p.lead { margin: 0 0 1.5rem 0; color: #475569; font-weight: 500; line-height: 1.6; }
        label { display:block; font-weight:700; margin-bottom: .5rem; color: #0553F0; font-size: .95rem; }
        .vin-input { width: 100%; padding: 1rem 1.25rem; border-radius: 12px; border: 2px solid #e6eefc; font-size: 1.05rem; outline: none; box-sizing: border-box; transition: all .2s; font-family: 'Courier New', monospace; background: white; }
        .vin-input:focus { border-color: #0553F0; box-shadow: 0 6px 18px rgba(5,83,240,0.15); transform: translateY(-1px); }
        .actions { margin-top: 1.5rem; display:flex; gap: .75rem; align-items:center; flex-wrap: wrap; }
        .btn { display:inline-block; padding:.85rem 1.5rem; border-radius: 10px; font-weight:700; cursor:pointer; border: none; transition: all .2s; font-size: .95rem; }
        .btn-primary { background: linear-gradient(135deg, #0553F0 0%, #0441c7 100%); color: white; box-shadow: 0 4px 12px rgba(5,83,240,0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(5,83,240,0.3); }
        .btn-ghost { background: white; color: #0553F0; border: 2px solid #e6eefc; }
        .btn-ghost:hover { background: #f8fafc; border-color: #0553F0; transform: translateY(-2px); }
        .btn-camera { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(16,185,129,0.2); }
        .btn-camera:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,0.3); }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.12); border-top-color: #0553F0; border-radius: 50%; display: inline-block; vertical-align: middle; margin-left: .6rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #cameraModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; padding: 1rem; }
        #cameraModal.active { display: flex; }
        .camera-container { max-width: 640px; width: 100%; background: white; border-radius: 16px; padding: 1.5rem; position: relative; }
        :root { --scanWidthPercent: 70%; --scanHeightPx: 60px; }
        #videoPreview { width: 100%; border-radius: 12px; background: #000; }
        .camera-controls { display: flex; gap: 0.75rem; margin-top: 1rem; justify-content: center; flex-wrap: wrap; }
        .scan-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px dashed #10b981; width: var(--scanWidthPercent); height: var(--scanHeightPx); pointer-events: none; border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
        .scan-guide::after { content: 'Align VIN here'; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); color: #10b981; font-weight: 700; font-size: 0.9rem; background: rgba(0,0,0,0.7); padding: 0.25rem 0.75rem; border-radius: 6px; }
        #vinResults { margin-top: 1.5rem; background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid #e6eefc; display: none; }
        #vinResults pre { white-space: pre-wrap; word-break: break-word; margin: 0; }
        .result-row { margin-bottom: .75rem; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; margin-bottom: 1.5rem; }
        .result-item { background: white; padding: 1rem 1.25rem; border-radius: 10px; border: 2px solid #e6eefc; box-shadow: 0 2px 8px rgba(2,6,23,0.04); transition: .2s; }
        .result-item:hover { border-color: #0553F0; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(2,6,23,0.08); }
        .result-item strong { display: block; font-size: .85rem; color: #64748b; text-transform: uppercase; letter-spacing: .5px; margin-bottom: .5rem; font-weight: 700; }
        .result-item span { display: block; font-size: 1.05rem; color: #0b1724; font-weight: 700; }
        .muted { color:#64748b; font-size:.95rem; }
        .recall-badge { display: inline-block; padding: .25rem .75rem; border-radius: 999px; font-weight: 600; font-size: .9rem; }
        .recall-ok { background: #d1fae5; color: #065f46; }
        .recall-warn { background: #fef3c7; color: #92400e; }
        footer { text-align:center; padding: 2rem 0; color:#475569; }
        @media (max-width:720px){ .actions { flex-direction: column; align-items: stretch; } }

            /* Safety and Market Comps UI */
            .section { margin-top: 1rem; background: #fff; border: 1px solid #e6eefc; border-radius: 10px; padding: 0.75rem 1rem; }
            .section h4 { margin: 0 0 .5rem 0; font-size: 1.05rem; color:#0b1724; }
            .mini-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: .5rem; }
            .mini-item { background:#f8fafc; border:1px solid #e6eefc; border-radius:8px; padding:.5rem .75rem; }
            .mini-item strong { display:block; font-size:.8rem; color:#64748b; text-transform:uppercase; letter-spacing:.4px; }
            .mini-item span { display:block; font-weight:700; color:#0b1724; }
            .comps-controls { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin:.25rem 0 .5rem 0; }
            .comps-controls input { width: 120px; padding:.5rem; border-radius:8px; border:1px solid #e6eefc; }
        .comps-table { width:100%; border-collapse: collapse; }
        .comps-table th, .comps-table td { text-align:left; padding:.5rem; border-bottom:1px solid #eef2f7; font-size:.95rem; }
        .comps-table th { color:#64748b; text-transform:uppercase; letter-spacing:.4px; font-size:.8rem; }
        .comps-scroll { overflow-x:auto; margin-top:.5rem; -webkit-overflow-scrolling: touch; }
        @media (max-width: 992px) {
            header { flex-wrap: wrap; }
            nav { width: 100%; display: none; flex-direction: column; gap: 1rem; background: rgba(4, 65, 199, 0.98); padding: 1rem; border-radius: 12px; margin-top: .5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
            nav.open { display: flex; }
            nav a, nav a.nav-link { margin-left: 0; padding: 0.75rem 1rem; min-height: 44px; display: flex; align-items: center; border-radius: 8px; transition: background 0.2s; }
            nav a:hover, nav a:focus { background: rgba(255,255,255,0.15); }
            .menu-toggle { display: inline-flex; min-height: 44px; min-width: 44px; }
        }
        @media (max-width:720px){ .comps-table { min-width: 600px; } }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="/" style="color:white;text-decoration:none;" aria-label="TrustCar.io homepage">TrustCar.io</a></div>
        <button id="menuToggle" class="menu-toggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="primaryNav">Menu ‚ò∞</button>
        <nav aria-label="Main navigation" id="primaryNav">
            <a class="nav-link" href="/">Home</a>
            <a class="nav-link" href="/pricing.html">Pricing</a>
            <a class="nav-link" href="/how-it-works.html">How It Works</a>
        </nav>
    </header>

    <main>
        <div class="card">
            <h1>Enter the Vehicle VIN</h1>
            <p class="lead">Enter the 17-character VIN of the vehicle you're considering. We'll instantly decode it, check for open recalls, safety ratings, and (when available) local market pricing.</p>
            <div id="checkoutMeta" class="muted" style="margin:.5rem 0 1rem 0; display:none"></div>

            <label for="vinInput">VIN</label>
            <input id="vinInput" class="vin-input" maxlength="17" placeholder="1HGCM82633A004352" aria-label="Vehicle VIN" />

            <div class="actions">
                <button id="vinDecodeBtn" class="btn btn-primary">Decode VIN</button>
                <button id="scanVinBtn" class="btn btn-camera">üì∑ Scan VIN</button>
                <button id="copyReportBtn" class="btn btn-ghost">Copy Report</button>
                <div id="statusMsg" class="muted" style="margin-left:auto"></div>
            </div>

            <!-- Camera Modal -->
            <div id="cameraModal" role="dialog" aria-label="VIN Scanner" aria-modal="true">
                <div class="camera-container">
                    <h3 style="margin:0 0 1rem;text-align:center;color:#0b1724;">Scan VIN with Camera</h3>
                    <p class="muted" style="text-align:center;margin-bottom:1rem;">Hold phone in landscape mode. Position VIN within the green box and hold steady.</p>
                    <div style="position:relative;">
                        <video id="videoPreview" autoplay playsinline></video>
                        <div class="scan-guide"></div>
                    </div>
                    <div style="display:flex;gap:.75rem;align-items:center;justify-content:center;margin-top:.75rem;flex-wrap:wrap;">
                        <label class="muted" for="widthRange">Box Width</label>
                        <input id="widthRange" type="range" min="60" max="90" value="70" step="1" aria-label="Scan box width percent" />
                        <span id="widthVal" class="muted">70%</span>
                        <label class="muted" for="heightRange" style="margin-left:.5rem;">Box Height</label>
                        <input id="heightRange" type="range" min="40" max="100" value="60" step="2" aria-label="Scan box height pixels" />
                        <span id="heightVal" class="muted">60px</span>
                    </div>
                    <canvas id="scanCanvas" style="display:none;"></canvas>
                    <div class="camera-controls">
                        <button id="captureBtn" class="btn btn-primary">Capture & Auto-Fill VIN</button>
                        <button id="barcodeBtn" class="btn btn-ghost">Try Barcode Scan</button>
                        <button id="flashBtn" class="btn btn-ghost">Toggle Flash</button>
                        <button id="closeCameraBtn" class="btn btn-ghost">Cancel</button>
                    </div>
                    <div id="scanStatus" class="muted" style="text-align:center;margin-top:1rem;"></div>
                </div>
            </div>

            <div id="vinResults" aria-live="polite" aria-busy="false" role="region" aria-label="VIN decode results"></div>
        </div>
    </main>

    <footer>
        <div class="muted">¬© 2025 TrustCar.io ‚Äî Instant VIN decoding with recalls, safety ratings, and market data</div>
    </footer>

    <script>
        // VIN decode + recall logic (adapted from index.html)
        let lastDecode = null;
        function showCheckoutMeta(){
            const metaEl = document.getElementById('checkoutMeta');
            const carried = localStorage.getItem('listingUrlOrVin') || '';
            const plan = localStorage.getItem('selectedPlan') || '';
            let txt = '';
            if (carried) {
                if (/^https?:\/\//i.test(carried)) {
                    txt += `Car listing: ${carried}`;
                } else if (/^[A-HJ-NPR-Z0-9]{17}$/i.test(carried)) {
                    txt += `VIN from checkout: ${carried}`;
                    const vinEl = document.getElementById('vinInput');
                    if (vinEl && !vinEl.value) vinEl.value = carried.toUpperCase();
                }
            }
            if (plan) txt += (txt ? ' ‚Ä¢ ' : '') + `Plan: ${plan}`;
            if (txt) { metaEl.textContent = txt; metaEl.style.display = 'block'; }
        }
        async function decodeVIN() {
            const vinEl = document.getElementById('vinInput');
            const vin = vinEl.value.trim();
            const statusEl = document.getElementById('statusMsg');
            
            if (!vin) {
                statusEl.textContent = 'Please enter a VIN';
                vinEl.style.borderColor = '#ef4444';
                vinEl.focus();
                return;
            }
            
            if (vin.length !== 17) {
                statusEl.textContent = 'VIN must be exactly 17 characters';
                vinEl.style.borderColor = '#ef4444';
                vinEl.focus();
                return;
            }
            
            if (!/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
                statusEl.textContent = 'VIN contains invalid characters';
                vinEl.style.borderColor = '#ef4444';
                vinEl.focus();
                return;
            }
            
            vinEl.style.borderColor = '#e6eefc';

            const resultsEl = document.getElementById('vinResults');
            const btn = document.getElementById('vinDecodeBtn');

            resultsEl.style.display = 'block';
            resultsEl.setAttribute('aria-busy', 'true');
            resultsEl.innerHTML = `
                <div style="text-align:center;padding:2rem;">
                    <div style="font-size:2rem;margin-bottom:1rem;">üîç</div>
                    <div style="font-weight:600;color:#0553F0;margin-bottom:.5rem;">Decoding VIN...</div>
                    <div class="muted">Fetching vehicle data from NHTSA database</div>
                </div>`;
            statusEl.textContent = '';

            // show spinner and disable button
            btn.disabled = true;
            const spinner = document.createElement('span');
            spinner.className = 'spinner';
            btn.appendChild(spinner);

            try {
                const decodeUrl = `https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${encodeURIComponent(vin)}?format=json`;
                const recallsUrl = `https://api.nhtsa.gov/recalls/recallsByVehicle?vin=${encodeURIComponent(vin)}`;

                const [decodeRes, recallsRes] = await Promise.all([
                    fetch(decodeUrl),
                    fetch(recallsUrl)
                ]);

                const decodeData = await decodeRes.json();
                const recallsData = await recallsRes.json();

                lastDecode = { decodeData, recallsData };

                const findVar = (name) => {
                    const item = decodeData.Results && decodeData.Results.find(r => r.Variable === name);
                    return item && item.Value ? item.Value : 'N/A';
                };

                const make = findVar('Make');
                const model = findVar('Model');
                const modelYear = findVar('Model Year') || findVar('ModelYear') || 'N/A';
                const bodyClass = findVar('Body Class') || 'N/A';
                const fuel = findVar('Fuel Type - Primary') || 'N/A';
                const trim = findVar('Trim') || 'N/A';
                const drivetrain = findVar('Drive Type') || 'N/A';
                const manufacturer = findVar('Manufacturer Name') || 'N/A';
                const vehicleType = findVar('Vehicle Type') || 'N/A';
                const plantCity = findVar('Plant City') || 'N/A';
                const plantCountry = findVar('Plant Country') || 'N/A';
                const engineCyl = findVar('Engine Number of Cylinders') || 'N/A';
                const engineDisp = findVar('Displacement (L)') || findVar('Displacement (CC)') || 'N/A';
                const transmission = findVar('Transmission Style') || 'N/A';
                const doors = findVar('Doors') || 'N/A';
                const series = findVar('Series') || 'N/A';

                const recallsCount = Array.isArray(recallsData.results) ? recallsData.results.length : (recallsData.count || 0);
                const recallBadge = recallsCount === 0 
                    ? '<span class="recall-badge recall-ok">‚úì No Recalls</span>' 
                    : `<span class="recall-badge recall-warn">‚ö† ${recallsCount} Recall${recallsCount > 1 ? 's' : ''}</span>`;

                // fetch safety ratings directly from NHTSA
                let safetyData = null;
                try {
                    const safetyUrl = `https://api.nhtsa.gov/SafetyRatings/modelyear/${modelYear}/make/${encodeURIComponent(make)}/model/${encodeURIComponent(model)}`;
                    const safetyRes = await fetch(safetyUrl);
                    if (safetyRes.ok) {
                        const safetyJson = await safetyRes.json();
                        // Get the first result if available
                        if (safetyJson.Results && safetyJson.Results.length > 0) {
                            const firstResult = safetyJson.Results[0];
                            safetyData = {
                                rated: true,
                                overallRating: firstResult.OverallRating || 'Not Rated',
                                overallFrontCrashRating: firstResult.OverallFrontCrashRating || 'Not Rated',
                                overallSideCrashRating: firstResult.OverallSideCrashRating || 'Not Rated',
                                rolloverRating: firstResult.RolloverRating || 'Not Rated',
                                vehicleDescription: firstResult.VehicleDescription || ''
                            };
                        }
                    }
                } catch(_e) { 
                    console.warn('Safety ratings unavailable:', _e);
                }
                const overall = safetyData && safetyData.rated && safetyData.overallRating && safetyData.overallRating !== 'Not Rated' ? safetyData.overallRating : null;
                const safetyBadge = overall 
                    ? `<span class="recall-badge" style="background:#dbeafe;color:#1e40af">‚òÖ Overall Safety: ${escapeHtml(overall)}</span>`
                    : '';

                // Build safety breakdown mini-grid
                let safetySection = '';
                if (safetyData && safetyData.rated) {
                    const f = (v) => (v && v !== 'Not Rated') ? escapeHtml(v) : '‚Äî';
                    safetySection = `
                        <div class="section" id="safetySection">
                            <h4>Safety Ratings (NHTSA)</h4>
                            <div class="mini-grid">
                                <div class="mini-item"><strong>Overall</strong><span>${f(safetyData.overallRating)}</span></div>
                                <div class="mini-item"><strong>Front Crash</strong><span>${f(safetyData.overallFrontCrashRating)}</span></div>
                                <div class="mini-item"><strong>Side Crash</strong><span>${f(safetyData.overallSideCrashRating)}</span></div>
                                <div class="mini-item"><strong>Rollover</strong><span>${f(safetyData.rolloverRating)}</span></div>
                            </div>
                            ${safetyData.vehicleDescription ? `<div class="muted" style="margin-top:.4rem">${escapeHtml(safetyData.vehicleDescription)}</div>` : ''}
                        </div>`;
                }

                // Market comps section shell (only if enabled server-side)
                let compsSection = '';
                try {
                    const cfgRes = await fetch('/api/config/features');
                    const cfg = cfgRes.ok ? await cfgRes.json() : {};
                    if (cfg.marketCompsEnabled) {
                        compsSection = `
                            <div class="section" id="compsSection">
                                <h4>Market Comps</h4>
                                <div class="comps-controls">
                                    <label for="zipInput" class="muted" style="font-weight:600;">ZIP Code</label>
                                    <input id="zipInput" placeholder="e.g. 94107" maxlength="5" aria-label="ZIP code for market search" />
                                    <label for="radiusInput" class="muted" style="font-weight:600;">Radius (mi)</label>
                                    <input id="radiusInput" type="number" min="10" max="500" placeholder="100" value="100" aria-label="Search radius in miles" />
                                    <button id="fetchCompsBtn" class="btn btn-ghost" aria-label="Fetch market comparables">Fetch Comps</button>
                                </div>
                                <div id="compsSummary" class="muted" role="status" aria-live="polite">No comps yet.</div>
                                <div class="comps-scroll">
                                    <table class="comps-table" id="compsTable" style="display:none;">
                                        <thead>
                                            <tr>
                                                <th>Price</th>
                                                <th>Miles</th>
                                                <th>Dealer</th>
                                                <th>Location</th>
                                                <th>DOM</th>
                                                <th>Link</th>
                                            </tr>
                                        </thead>
                                        <tbody id="compsTbody"></tbody>
                                    </table>
                                </div>
                            </div>`;
                    }
                } catch(_e) { /* comps unavailable */ }

                resultsEl.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <h2 style="margin: 0 0 .5rem 0; font-size: 1.5rem;">${escapeHtml(modelYear)} ${escapeHtml(make)} ${escapeHtml(model)}</h2>
                        <div style="margin-bottom: .5rem; display:flex; gap:.5rem; flex-wrap:wrap;">${recallBadge}${overall ? ' ' + safetyBadge : ''}</div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item"><strong>Manufacturer</strong><span>${escapeHtml(manufacturer)}</span></div>
                        <div class="result-item"><strong>Body Style</strong><span>${escapeHtml(bodyClass)}</span></div>
                        <div class="result-item"><strong>Vehicle Type</strong><span>${escapeHtml(vehicleType)}</span></div>
                        <div class="result-item"><strong>Trim</strong><span>${escapeHtml(trim)}</span></div>
                        <div class="result-item"><strong>Series</strong><span>${escapeHtml(series)}</span></div>
                        <div class="result-item"><strong>Drive Type</strong><span>${escapeHtml(drivetrain)}</span></div>
                        <div class="result-item"><strong>Fuel Type</strong><span>${escapeHtml(fuel)}</span></div>
                        <div class="result-item"><strong>Engine</strong><span>${escapeHtml(engineCyl)} cyl, ${escapeHtml(engineDisp)}</span></div>
                        <div class="result-item"><strong>Transmission</strong><span>${escapeHtml(transmission)}</span></div>
                        <div class="result-item"><strong>Doors</strong><span>${escapeHtml(doors)}</span></div>
                        <div class="result-item"><strong>Plant Location</strong><span>${escapeHtml(plantCity)}, ${escapeHtml(plantCountry)}</span></div>
                    </div>
                    ${safetySection}
                    ${compsSection}
                    <div style="margin-top:2rem;padding-top:1.5rem;border-top:2px solid #e6eefc;text-align:center;">
                        <p style="margin-bottom:1rem;color:#475569;font-weight:500;">Ready to get a complete inspection of this vehicle?</p>
                        <a href="/pricing.html" class="btn btn-primary" style="text-decoration:none;display:inline-block;">Start Inspection ‚Äî From $49</a>
                    </div>
                `;

                // Wire up Market Comps fetch
                const fetchBtn = document.getElementById('fetchCompsBtn');
                if (fetchBtn) {
                    fetchBtn.addEventListener('click', () => fetchAndRenderComps(vin));
                    // initial fetch without zip
                    fetchAndRenderComps(vin);
                }

                // Save the full decode data to server for admin/auditing
                saveVinDecodeToServer(vin, decodeData, recallsData, safetyData);

                        } catch (err) {
                resultsEl.innerHTML = `
                    <div style="background:#fef3c7;border:2px solid #f59e0b;padding:1.5rem;border-radius:12px;color:#78350f;">
                        <strong style="display:block;margin-bottom:.75rem;font-size:1.1rem;">‚ö† Unable to Fetch VIN Data</strong>
                        <p style="margin:0 0 1rem;line-height:1.6;">The NHTSA VIN API may be temporarily unavailable. Please try again in a few moments.</p>
                        <details style="margin-top:.75rem;">
                            <summary style="cursor:pointer;font-weight:600;user-select:none;">Technical Details</summary>
                            <pre style="margin:.5rem 0 0;font-size:.85rem;overflow-x:auto;background:#fff;padding:.75rem;border-radius:6px;">${escapeHtml(err.message || err.toString())}</pre>
                        </details>
                        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #f59e0b;">
                            <a href="/" style="color:#0553F0;font-weight:600;text-decoration:none;">‚Üê Back to Home</a>
                            <span style="margin:0 .75rem;color:#cbd5e1;">|</span>
                            <a href="/how-it-works.html" style="color:#0553F0;font-weight:600;text-decoration:none;">Learn How It Works</a>
                        </div>
                    </div>`;
                resultsEl.setAttribute('aria-busy', 'false');
                console.error('VIN decode error:', err);
            } finally {
                if (spinner && spinner.parentNode) spinner.parentNode.removeChild(spinner);
                btn.disabled = false;
                resultsEl.setAttribute('aria-busy', 'false');
            }
        }

        function escapeHtml(s){
            if (s === null || s === undefined) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        async function saveVinDecodeToServer(vin, decodeData, recallsData, safetyData) {
            try {
                await fetch('/api/vin-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vin: vin,
                        decodeData: decodeData,
                        recallsData: recallsData,
                        safetyData: safetyData || null,
                        timestamp: Date.now()
                    })
                });
            } catch (err) {
                console.warn('Could not save VIN data to server:', err);
            }
        }

        async function fetchAndRenderComps(vin) {
            const zipInput = document.getElementById('zipInput');
            const radiusInput = document.getElementById('radiusInput');
            const zip = (zipInput?.value || '').trim();
            const radiusRaw = (radiusInput?.value || '').trim();
            const radius = parseInt(radiusRaw || '100', 10);
            
            // Validate ZIP format if provided
            if (zip && !/^\d{5}$/.test(zip)) {
                const sumEl = document.getElementById('compsSummary');
                if (sumEl) sumEl.textContent = 'Invalid ZIP code format (must be 5 digits)';
                if (zipInput) zipInput.style.borderColor = '#ef4444';
                return;
            }
            if (zipInput) zipInput.style.borderColor = '#e6eefc';
            
            // Validate radius range
            if (isNaN(radius) || radius < 10 || radius > 500) {
                const sumEl = document.getElementById('compsSummary');
                if (sumEl) sumEl.textContent = 'Radius must be between 10 and 500 miles';
                if (radiusInput) radiusInput.style.borderColor = '#ef4444';
                return;
            }
            if (radiusInput) radiusInput.style.borderColor = '#e6eefc';
            
            const qs = new URLSearchParams({ vin });
            if (zip) qs.set('zip', zip);
            if (!isNaN(radius)) qs.set('radius', String(radius));
            const sumEl = document.getElementById('compsSummary');
            const table = document.getElementById('compsTable');
            const tbody = document.getElementById('compsTbody');
            if (sumEl) sumEl.textContent = 'Loading comps...';
            if (table) table.style.display = 'none';
            if (tbody) tbody.innerHTML = '';
            try {
                const res = await fetch(`/api/vin/market-comps?${qs.toString()}`);
                if (!res.ok) throw new Error('Request failed');
                const data = await res.json();
                const s = data.stats || {};
                const parts = [];
                if (s.count) parts.push(`${s.count} matches`);
                if (s.min != null && s.max != null) parts.push(`$${s.min.toLocaleString()}‚Äì$${s.max.toLocaleString()}`);
                if (s.median != null) parts.push(`median $${s.median.toLocaleString()}`);
                if (s.avg_days_on_market != null) parts.push(`avg ${s.avg_days_on_market} DOM`);
                if (sumEl) {
                    if (parts.length) {
                        sumEl.textContent = parts.join(' ‚Ä¢ ');
                        sumEl.style.color = '#475569';
                    } else {
                        sumEl.textContent = 'No comps found in the specified area. Try increasing the search radius.';
                        sumEl.style.color = '#64748b';
                    }
                }

                const rows = (data.sample || []).slice(0, 8).map(item => {
                    const price = item.price != null ? `$${Number(item.price).toLocaleString()}` : '‚Äî';
                    const miles = item.miles != null ? Number(item.miles).toLocaleString() : '‚Äî';
                    const dealer = item.dealer || '‚Äî';
                    const loc = [item.city, item.state].filter(Boolean).join(', ') || '‚Äî';
                    const dom = item.dom != null ? item.dom : '‚Äî';
                    const link = item.vdp_url ? `<a href="${escapeHtml(item.vdp_url)}" target="_blank" rel="noopener">View</a>` : '‚Äî';
                    return `<tr>
                        <td>${price}</td>
                        <td>${miles}</td>
                        <td>${escapeHtml(dealer)}</td>
                        <td>${escapeHtml(loc)}</td>
                        <td>${escapeHtml(dom)}</td>
                        <td>${link}</td>
                    </tr>`;
                }).join('');
                if (tbody) tbody.innerHTML = rows;
                if (table && rows) table.style.display = '';
            } catch (e) {
                if (sumEl) sumEl.textContent = 'Comps unavailable (server not configured or network error).';
                console.warn('comps error', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            showCheckoutMeta();
            
            const vinInput = document.getElementById('vinInput');
            
            // Real-time VIN validation and formatting
            vinInput.addEventListener('input', (e) => {
                // Convert to uppercase and remove invalid characters (I, O, Q not allowed in VINs)
                e.target.value = e.target.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
            });
            
            // Validate on blur
            vinInput.addEventListener('blur', (e) => {
                const vin = e.target.value.trim();
                if (vin && vin.length !== 17) {
                    e.target.style.borderColor = '#ef4444';
                    const statusEl = document.getElementById('statusMsg');
                    if (statusEl) statusEl.textContent = 'VIN must be exactly 17 characters';
                } else {
                    e.target.style.borderColor = '#e6eefc';
                    const statusEl = document.getElementById('statusMsg');
                    if (statusEl) statusEl.textContent = '';
                }
            });
            
            // Clear error on focus
            vinInput.addEventListener('focus', (e) => {
                e.target.style.borderColor = '#0553F0';
                const statusEl = document.getElementById('statusMsg');
                if (statusEl) statusEl.textContent = '';
            });
            
            document.getElementById('vinDecodeBtn').addEventListener('click', (e) => {
                decodeVIN();
            });

            vinInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    decodeVIN();
                }
            });

            document.getElementById('copyReportBtn').addEventListener('click', () => {
                if (!lastDecode) return alert('Run a VIN lookup first.');
                const text = buildReportText(lastDecode);
                navigator.clipboard.writeText(text).then(() => {
                    const s = document.getElementById('statusMsg');
                    s.textContent = 'Report copied to clipboard';
                    setTimeout(() => s.textContent = '', 3000);
                }).catch(() => alert('Could not copy to clipboard.'));
            });


        });

        function buildReportText(data){
            const vin = document.getElementById('vinInput').value.trim();
            const decode = data.decodeData || {};
            const recalls = data.recallsData || {};
            
            // Helper to extract decode variables
            const findVar = (name) => {
                const item = decode.Results && decode.Results.find(r => r.Variable === name);
                return item && item.Value ? item.Value : 'N/A';
            };
            
            const make = findVar('Make');
            const model = findVar('Model');
            const year = findVar('Model Year') || findVar('ModelYear');
            const bodyClass = findVar('Body Class');
            const fuel = findVar('Fuel Type - Primary');
            const trim = findVar('Trim');
            const drivetrain = findVar('Drive Type');
            const engineCyl = findVar('Engine Number of Cylinders');
            const engineDisp = findVar('Displacement (L)');
            const transmission = findVar('Transmission Style');
            const doors = findVar('Doors');
            
            const recallsCount = Array.isArray(recalls.results) ? recalls.results.length : (recalls.count || 0);

            let report = `TRUSTCAR.IO VIN DECODE REPORT\n`;
            report += `=================================\n\n`;
            report += `VIN: ${vin}\n`;
            report += `Vehicle: ${year} ${make} ${model}\n\n`;
            report += `VEHICLE DETAILS:\n`;
            report += `  Trim: ${trim}\n`;
            report += `  Body Style: ${bodyClass}\n`;
            report += `  Doors: ${doors}\n`;
            report += `  Drive Type: ${drivetrain}\n`;
            report += `  Fuel Type: ${fuel}\n\n`;
            report += `ENGINE & TRANSMISSION:\n`;
            report += `  Engine: ${engineCyl} cylinders, ${engineDisp}L\n`;
            report += `  Transmission: ${transmission}\n\n`;
            report += `RECALLS: ${recallsCount === 0 ? 'None' : recallsCount + ' open recall(s)'}\n\n`;
            report += `Report generated: ${new Date().toLocaleString()}\n`;
            report += `\n---\nFor full inspection and market analysis, visit TrustCar.io`;
            
            return report;
        }
    </script>

    <script>
        const menuToggle = document.getElementById('menuToggle');
        const primaryNav = document.getElementById('primaryNav');
        if (menuToggle && primaryNav) {
            menuToggle.addEventListener('click', () => {
                const isOpen = primaryNav.classList.toggle('open');
                menuToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            });
        }

        // Camera VIN Scanner
        let videoStream = null;
        const cameraModal = document.getElementById('cameraModal');
        const videoPreview = document.getElementById('videoPreview');
        const scanCanvas = document.getElementById('scanCanvas');
        const scanStatus = document.getElementById('scanStatus');
        const scanVinBtn = document.getElementById('scanVinBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const barcodeBtn = document.getElementById('barcodeBtn');
        const flashBtn = document.getElementById('flashBtn');
        const widthRange = document.getElementById('widthRange');
        const heightRange = document.getElementById('heightRange');
        const widthVal = document.getElementById('widthVal');
        const heightVal = document.getElementById('heightVal');

        function updateScanGuideCSS() {
            const w = (parseInt(widthRange.value, 10) || 70);
            const h = (parseInt(heightRange.value, 10) || 60);
            document.documentElement.style.setProperty('--scanWidthPercent', w + '%');
            document.documentElement.style.setProperty('--scanHeightPx', h + 'px');
            widthVal.textContent = w + '%';
            heightVal.textContent = h + 'px';
        }
        if (widthRange && heightRange) {
            widthRange.addEventListener('input', updateScanGuideCSS);
            heightRange.addEventListener('input', updateScanGuideCSS);
            updateScanGuideCSS();
        }

        scanVinBtn.addEventListener('click', async () => {
            try {
                cameraModal.classList.add('active');
                scanStatus.textContent = 'Starting camera...';

                // Lock screen orientation to landscape if supported
                if (screen.orientation && screen.orientation.lock) {
                    try {
                        await screen.orientation.lock('landscape').catch(() => {
                            console.log('Orientation lock not supported');
                        });
                    } catch (e) {
                        console.log('Orientation lock failed:', e);
                    }
                }

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                videoPreview.srcObject = videoStream;

                // Wait until video has metadata and is ready
                await new Promise((resolve) => {
                    if (videoPreview.readyState >= 1) return resolve();
                    videoPreview.onloadedmetadata = () => resolve();
                });
                try { await videoPreview.play(); } catch(_e) {}

                scanStatus.textContent = 'Position VIN in the green box. Hold steady for best results.';
                captureBtn.disabled = false;
                if (flashBtn) flashBtn.disabled = false;
                if (barcodeBtn) barcodeBtn.disabled = false;
            } catch (err) {
                scanStatus.textContent = 'Camera access denied or unavailable';
                console.error('Camera error:', err);
            }
        });
        // Toggle flashlight/torch if supported
        flashBtn.addEventListener('click', async () => {
            try {
                if (!videoStream) return;
                const track = videoStream.getVideoTracks()[0];
                const caps = track.getCapabilities();
                if (caps.torch) {
                    const current = track.getSettings().torch || false;
                    await track.applyConstraints({ advanced: [{ torch: !current }] });
                    flashBtn.textContent = !current ? 'Flash On' : 'Flash Off';
                } else {
                    scanStatus.textContent = 'Flash not supported on this device.';
                    setTimeout(() => scanStatus.textContent = '', 2000);
                }
            } catch (e) {
                console.log('Torch toggle error:', e);
            }
        });

        // VIN check-digit utilities (ISO 3779)
        function transliterate(char) {
            const map = {
                A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,
                J:1,K:2,L:3,M:4,N:5,P:7,R:9,
                S:2,T:3,U:4,V:5,W:6,X:7,Y:8,Z:9
            };
            if (/^[0-9]$/.test(char)) return parseInt(char,10);
            return map[char] || 0;
        }
        function computeVinCheckDigit(vin) {
            // weights per position 1..17
            const weights = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
            let sum = 0;
            for (let i=0;i<17;i++) {
                const val = transliterate(vin[i]);
                sum += val * weights[i];
            }
            const remainder = sum % 11;
            return remainder === 10 ? 'X' : String(remainder);
        }
        function isValidVin(vin) {
            if (!/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) return false;
            return computeVinCheckDigit(vin) === vin[8];
        }
        function tryCorrectVin(text) {
            // Normalize and apply common substitutions, then validate windows of 17 chars
            const clean = text.toUpperCase().replace(/\s|-/g,'').replace(/O/g,'0').replace(/I/g,'1').replace(/Q/g,'0');
            // Try sliding window
            for (let i=0;i<=clean.length-17;i++) {
                let candidate = clean.slice(i,i+17);
                // Additional ambiguous fixes
                candidate = candidate.replace(/B/g,'8').replace(/S/g,'5').replace(/Z/g,'2');
                if (/^[A-HJ-NPR-Z0-9]{17}$/.test(candidate) && isValidVin(candidate)) {
                    return candidate;
                }
            }
            return null;
        }

        // Barcode scanning from current frame (Code39/Code128)
        barcodeBtn.addEventListener('click', async () => {
            if (!videoStream) return;
            scanStatus.textContent = 'üîé Scanning barcode...';
            // capture full frame
            const canvas = document.createElement('canvas');
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoPreview, 0, 0);
            const dataUrl = canvas.toDataURL('image/png');
            try {
                Quagga.decodeSingle({
                    src: dataUrl,
                    locate: true,
                    decoder: { readers: ['code_39_reader','code_128_reader'] }
                }, (result) => {
                    if (result && result.codeResult && result.codeResult.code) {
                        const code = result.codeResult.code.toUpperCase();
                        const cleaned = code.replace(/[^A-Z0-9]/g,'');
                        const candidate = tryCorrectVin(cleaned) || cleaned;
                        if (/^[A-HJ-NPR-Z0-9]{17}$/.test(candidate)) {
                            document.getElementById('vinInput').value = candidate;
                            // close camera
                            if (videoStream) { videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
                            if (screen.orientation && screen.orientation.unlock) { try{screen.orientation.unlock();}catch(e){} }
                            cameraModal.classList.remove('active');
                            scanStatus.textContent = '';
                            setTimeout(()=>decodeVIN(), 300);
                        } else {
                            scanStatus.textContent = 'No VIN found in barcode. Try repositioning.';
                            setTimeout(()=> scanStatus.textContent = '', 2000);
                        }
                    } else {
                        scanStatus.textContent = 'Barcode not detected. Try the text scan or adjust box.';
                        setTimeout(()=> scanStatus.textContent = '', 2000);
                    }
                });
            } catch(e) {
                console.log('Barcode scan error', e);
                scanStatus.textContent = 'Barcode scan error.';
                setTimeout(()=> scanStatus.textContent = '', 2000);
            }
        });

        closeCameraBtn.addEventListener('click', () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            // Unlock screen orientation
            if (screen.orientation && screen.orientation.unlock) {
                try {
                    screen.orientation.unlock();
                } catch (e) {
                    console.log('Orientation unlock failed:', e);
                }
            }
            
            cameraModal.classList.remove('active');
            scanStatus.textContent = '';
        });

        captureBtn.addEventListener('click', async () => {
            if (!videoStream) return;

            // Ensure video has dimensions
            if (!videoPreview.videoWidth || !videoPreview.videoHeight) {
                scanStatus.textContent = 'Camera not ready. Please wait a moment.';
                return;
            }

            scanStatus.textContent = 'üì∏ Capturing image...';
            captureBtn.disabled = true;

            // Capture frame from video to a canvas
            const fullCanvas = scanCanvas;
            fullCanvas.width = videoPreview.videoWidth;
            fullCanvas.height = videoPreview.videoHeight;
            const fullCtx = fullCanvas.getContext('2d');
            fullCtx.drawImage(videoPreview, 0, 0);

            // Compute ROI based on scan-guide (90% width, 100px height centered)
            // Read dynamic ROI from sliders
            const scanWidthPercentStr = getComputedStyle(document.documentElement).getPropertyValue('--scanWidthPercent').trim();
            const scanHeightPxStr = getComputedStyle(document.documentElement).getPropertyValue('--scanHeightPx').trim();
            const scanWidthPercent = Math.max(0.6, Math.min(0.9, parseFloat(scanWidthPercentStr) / 100 || 0.7));
            const scanHeightPx = Math.max(40, Math.min(100, parseInt(scanHeightPxStr, 10) || 60));

            const roiWidth = Math.floor(fullCanvas.width * scanWidthPercent);
            const roiHeight = scanHeightPx; // pixels
            const roiX = Math.floor((fullCanvas.width - roiWidth) / 2);
            const roiY = Math.floor((fullCanvas.height - roiHeight) / 2);

            // Create cropped canvas for OCR
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = roiWidth;
            cropCanvas.height = roiHeight;
            const cropCtx = cropCanvas.getContext('2d');
            cropCtx.drawImage(fullCanvas, roiX, roiY, roiWidth, roiHeight, 0, 0, roiWidth, roiHeight);

            // Upscale ROI to improve OCR character size
            const ocrCanvas = document.createElement('canvas');
            ocrCanvas.width = roiWidth * 2;
            ocrCanvas.height = roiHeight * 2;
            const ocrCtx = ocrCanvas.getContext('2d');
            ocrCtx.imageSmoothingEnabled = false;
            ocrCtx.drawImage(cropCanvas, 0, 0, ocrCanvas.width, ocrCanvas.height);

            // Preprocess: grayscale + contrast boost
            const imageData = ocrCtx.getImageData(0, 0, ocrCanvas.width, ocrCanvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                const contrast = ((gray - 128) * 2.0) + 128;
                const clamped = Math.max(0, Math.min(255, contrast));
                // Binarize to reduce noise
                const thresh = 160;
                const bw = clamped >= thresh ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = bw;
            }
            ocrCtx.putImageData(imageData, 0, 0);

            scanStatus.textContent = 'üîç Reading VIN with AI...';

            try {
                const result = await Tesseract.recognize(
                    ocrCanvas,
                    'eng',
                    {
                        tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
                        tessedit_pageseg_mode: 7,
                        logger: (m) => {
                            if (m.status === 'recognizing text') {
                                scanStatus.textContent = `üîç Reading VIN... ${Math.round(m.progress * 100)}%`;
                            }
                        }
                    }
                );

                const rawText = result.data.text || '';
                const corrected = tryCorrectVin(rawText);

                if (corrected) {
                    const detectedVin = corrected;
                    document.getElementById('vinInput').value = detectedVin;
                    scanStatus.textContent = `‚úÖ VIN detected: ${detectedVin}`;

                    // Stop camera and close immediately
                    if (videoStream) {
                        videoStream.getTracks().forEach(track => track.stop());
                        videoStream = null;
                    }
                    if (screen.orientation && screen.orientation.unlock) {
                        try { screen.orientation.unlock(); } catch (e) {}
                    }
                    cameraModal.classList.remove('active');
                    scanStatus.textContent = '';
                    captureBtn.disabled = false;

                    // Auto-trigger decode
                    document.getElementById('vinInput').focus();
                    setTimeout(() => decodeVIN(), 300);
                } else {
                    scanStatus.textContent = '‚ùå No VIN detected. Try repositioning and capture again.';
                    captureBtn.disabled = false;
                }
            } catch (err) {
                console.error('OCR Error:', err);
                scanStatus.textContent = '‚ùå Error reading VIN. Please try again or enter manually.';
                captureBtn.disabled = false;
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && cameraModal.classList.contains('active')) {
                closeCameraBtn.click();
            }
        });
    </script>
</body>
</html>