<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout — TrustCar.io</title>
    <meta name="description" content="Complete your TrustCar.io inspection purchase securely with Stripe.">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f8fa; color: #0b1724; }
        header { background: linear-gradient(135deg, #0553F0 0%, #0441c7 100%); color: white; padding: 1.5rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(5,83,240,0.15); }
        .logo { font-size: 1.8rem; font-weight: 800; }
        main { padding: 3rem 5%; display: flex; justify-content: center; min-height: 60vh; }
        .card { width: 100%; max-width: 600px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; padding: 2.5rem; box-shadow: 0 8px 24px rgba(2,6,23,0.08); border: 2px solid #e6eefc; }
        h1 { margin: 0 0 0.75rem 0; font-size: 2rem; font-weight: 800; color: #0b1724; }
        p.lead { margin: 0 0 1.5rem 0; color: #475569; font-weight: 500; line-height: 1.6; }
        .summary { background: #f8fafc; border: 2px solid #e6eefc; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; padding: .75rem 0; border-bottom: 1px solid #e6eefc; }
        .summary-row:last-child { border: none; }
        .summary-label { font-weight: 600; color: #64748b; }
        .summary-value { font-weight: 700; color: #0b1724; font-size: 1.05rem; }
        .summary-total { font-size: 1.8rem; color: #0553F0; }
        label { display: block; font-weight: 700; margin-bottom: .5rem; color: #0553F0; font-size: .95rem; }
        input { width: 100%; padding: 1rem 1.25rem; border-radius: 12px; border: 2px solid #e6eefc; font-size: 1rem; outline: none; box-sizing: border-box; transition: all .2s; background: white; font-family: inherit; }
        input:focus { border-color: #0553F0; box-shadow: 0 6px 18px rgba(5,83,240,0.15); transform: translateY(-1px); }
        .field { margin-bottom: 1.25rem; }
        .btn { display: block; width: 100%; padding: 1rem 1.5rem; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; transition: all .2s; font-size: 1rem; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #0553F0 0%, #0441c7 100%); color: white; box-shadow: 0 4px 12px rgba(5,83,240,0.25); }
        .btn-primary:hover { background: linear-gradient(135deg, #0441c7 0%, #033ba3 100%); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(5,83,240,0.35); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; display: inline-block; vertical-align: middle; margin-left: .6rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .security-badge { display: flex; align-items: center; justify-content: center; gap: .5rem; color: #64748b; font-size: .85rem; margin-top: 1rem; }
        .security-badge svg { width: 20px; height: 20px; fill: #10b981; }
        .muted { color: #64748b; font-size: .9rem; }
        footer { text-align: center; padding: 2rem 0; color: #475569; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="/" style="color:white;text-decoration:none;" aria-label="TrustCar.io homepage">TrustCar.io</a></div>
    </header>

    <main>
        <div class="card">
            <h1>Complete Your Purchase</h1>
            <p class="lead">You're one step away from your comprehensive vehicle inspection report.</p>

            <div class="summary">
                <div class="summary-row">
                    <span class="summary-label">Inspection Tier:</span>
                    <span class="summary-value" id="tierName">—</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total:</span>
                    <span class="summary-value summary-total" id="totalPrice">$0</span>
                </div>
            </div>

            <div class="field">
                <label for="vinOrListing">VIN or Listing URL (optional)</label>
                <input id="vinOrListing" placeholder="e.g. 1HGCM82633A004352 or https://..." aria-label="VIN or car listing URL">
                <div class="muted" style="margin-top:.5rem;">Enter the VIN or paste a listing link. You can also add this after checkout.</div>
            </div>

            <button id="checkoutBtn" class="btn btn-primary">
                Proceed to Secure Payment
            </button>

            <div class="security-badge">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 17.93c-3.95-.49-7-3.85-7-7.93v-4.26l7-3.11v15.3z"/></svg>
                Secured by Stripe • SSL Encrypted • PCI Compliant
            </div>
        </div>
    </main>

    <footer>
        <div class="muted">© 2025 TrustCar.io — Instant VIN decoding with recalls, safety ratings, and market data</div>
    </footer>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const tier = urlParams.get('tier') || 'basic';

        const tierPrices = {
            basic: 49,
            plus: 119,
            premium: 229
        };

        const tierNames = {
            basic: 'Basic',
            plus: 'Plus',
            premium: 'Premium'
        };

        const price = tierPrices[tier] || 49;
        document.getElementById('tierName').textContent = tierNames[tier] || tier;
        document.getElementById('totalPrice').textContent = '$' + price;

        const checkoutBtn = document.getElementById('checkoutBtn');
        const vinOrListingInput = document.getElementById('vinOrListing');

        checkoutBtn.addEventListener('click', async () => {
            checkoutBtn.disabled = true;
            const spinner = document.createElement('span');
            spinner.className = 'spinner';
            checkoutBtn.appendChild(spinner);
            checkoutBtn.textContent = 'Redirecting to Stripe...';
            checkoutBtn.appendChild(spinner);

            const payload = { tier };

            try {
                const res = await fetch('/api/checkout/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({ error: 'Checkout failed' }));
                    throw new Error(err.error || 'Failed to create checkout session');
                }

                const data = await res.json();
                if (!data.id) throw new Error('No session ID returned');

                // Redirect to Stripe Checkout using the session ID
                const stripeCheckoutUrl = `https://checkout.stripe.com/pay/${data.id}`;
                window.location.href = stripeCheckoutUrl;
            } catch (err) {
                alert('Checkout error: ' + err.message);
                console.error(err);
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'Proceed to Secure Payment';
            }
        });
    </script>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Initialize Stripe.js when publishable key is available
        (async () => {
            try {
                const configRes = await fetch('/api/stripe/config');
                if (configRes.ok) {
                    const config = await configRes.json();
                    if (config.publishableKey) {
                        const stripe = Stripe(config.publishableKey);
                        // Store globally so checkout handler can use it
                        window.stripeInstance = stripe;
                    }
                }
            } catch (e) {
                console.warn('Could not load Stripe config', e);
            }
        })();

        // Update checkout button handler to use Stripe.js
        checkoutBtn.addEventListener('click', async (e) => {
            if (e.defaultPrevented) return; // already handled
            e.preventDefault();

            if (!window.stripeInstance) {
                alert('Stripe is not configured. Please add STRIPE_SECRET_KEY and STRIPE_PUBLISHABLE_KEY to your .env file.');
                return;
            }

            checkoutBtn.disabled = true;
            const spinner = document.createElement('span');
            spinner.className = 'spinner';
            checkoutBtn.textContent = 'Redirecting to Stripe';
            checkoutBtn.appendChild(spinner);

            const payload = {
                plan: tier,
                listingUrl: vinOrListingInput.value.trim() || '',
                vin: vinOrListingInput.value.trim() || ''
            };

            try {
                const res = await fetch('/api/checkout/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({ error: 'Checkout failed' }));
                    throw new Error(err.error || 'Failed to create checkout session');
                }

                const data = await res.json();
                if (!data.id) throw new Error('No session ID returned');

                // Use Stripe.js to redirect
                const result = await window.stripeInstance.redirectToCheckout({ sessionId: data.id });
                if (result.error) {
                    throw new Error(result.error.message);
                }
            } catch (err) {
                alert('Checkout error: ' + err.message);
                console.error(err);
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = 'Proceed to Secure Payment';
            }
        }, { once: false }); // allow duplicate listener since first was inline
    </script>
</body>
</html>
